---

title: Get the raw data


keywords: fastai
sidebar: home_sidebar



nb_path: "999_ex_statsbomb_spadl_prepare.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 999_ex_statsbomb_spadl_prepare.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1><center> Football sequence data with continuous and categorical features </center></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this tutorial, we take advantage of the <a href="https://github.com/ML-KULeuven/socceraction">socceraction</a> library and the <a href="https://github.com/statsbomb/open-data">statsbomb open data</a>. This code is highly inspired from this <a href="https://github.com/ML-KULeuven/socceraction/blob/master/public-notebooks/1-load-and-convert-statsbomb-data.ipynb">tutorial</a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">sample</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">progressbar</span>
<span class="kn">import</span> <span class="nn">socceraction.spadl</span> <span class="k">as</span> <span class="nn">spadl</span>
<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">from</span> <span class="nn">fastcore.foundation</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">socceraction.data.statsbomb</span> <span class="kn">import</span> <span class="n">StatsBombLoader</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_columns&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">PerformanceWarning</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's now map a folder in google drive where we can save some files when needed:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">base_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">free_open_data_remote</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;https://raw.githubusercontent.com/statsbomb/open-data/master/data/&quot;</span>
<span class="p">)</span>
<span class="n">SBL</span> <span class="o">=</span> <span class="n">StatsBombLoader</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">free_open_data_remote</span><span class="p">,</span> <span class="n">getter</span><span class="o">=</span><span class="s2">&quot;remote&quot;</span><span class="p">)</span>

<span class="c1"># check available competitions</span>
<span class="n">competitions</span> <span class="o">=</span> <span class="n">SBL</span><span class="o">.</span><span class="n">competitions</span><span class="p">()</span>
<span class="nb">set</span><span class="p">(</span><span class="n">competitions</span><span class="o">.</span><span class="n">competition_name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;Champions League&#39;,
 &#34;FA Women&#39;s Super League&#34;,
 &#39;FIFA World Cup&#39;,
 &#39;La Liga&#39;,
 &#39;NWSL&#39;,
 &#39;Premier League&#39;,
 &#39;UEFA Euro&#39;,
 &#34;Women&#39;s World Cup&#34;}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It is enough to focus on a few competitions here. It will provide us with enough games to create our sequences:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">selected_comp_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Champions League&quot;</span><span class="p">,</span> <span class="s2">&quot;La Liga&quot;</span><span class="p">,</span> <span class="s2">&quot;Premier League&quot;</span><span class="p">]</span>
<span class="n">selected_competitions</span> <span class="o">=</span> <span class="n">competitions</span><span class="p">[</span>
    <span class="n">competitions</span><span class="o">.</span><span class="n">competition_name</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_comp_names</span><span class="p">)</span>
<span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;season_name&quot;</span><span class="p">,</span> <span class="s2">&quot;competition_name&quot;</span><span class="p">])</span>
<span class="n">selected_competitions</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>season_id</th>
      <th>competition_id</th>
      <th>competition_name</th>
      <th>country_name</th>
      <th>competition_gender</th>
      <th>season_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>14</th>
      <td>76</td>
      <td>16</td>
      <td>Champions League</td>
      <td>Europe</td>
      <td>male</td>
      <td>1999/2000</td>
    </tr>
    <tr>
      <th>13</th>
      <td>44</td>
      <td>16</td>
      <td>Champions League</td>
      <td>Europe</td>
      <td>male</td>
      <td>2003/2004</td>
    </tr>
    <tr>
      <th>37</th>
      <td>44</td>
      <td>2</td>
      <td>Premier League</td>
      <td>England</td>
      <td>male</td>
      <td>2003/2004</td>
    </tr>
    <tr>
      <th>12</th>
      <td>37</td>
      <td>16</td>
      <td>Champions League</td>
      <td>Europe</td>
      <td>male</td>
      <td>2004/2005</td>
    </tr>
    <tr>
      <th>35</th>
      <td>37</td>
      <td>11</td>
      <td>La Liga</td>
      <td>Spain</td>
      <td>male</td>
      <td>2004/2005</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we are ready to extract the list of games available in each season/competition combination:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">games</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">SBL</span><span class="o">.</span><span class="n">games</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">competition_id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">season_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">selected_competitions</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">games</span><span class="p">[[</span><span class="s2">&quot;home_team_id&quot;</span><span class="p">,</span> <span class="s2">&quot;away_team_id&quot;</span><span class="p">,</span> <span class="s2">&quot;game_date&quot;</span><span class="p">,</span> <span class="s2">&quot;home_score&quot;</span><span class="p">,</span> <span class="s2">&quot;away_score&quot;</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>home_team_id</th>
      <th>away_team_id</th>
      <th>game_date</th>
      <th>home_score</th>
      <th>away_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>129</td>
      <td>256</td>
      <td>2004-05-26 12:00:00</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>0</th>
      <td>46</td>
      <td>1</td>
      <td>2004-02-07 16:00:00</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>46</td>
      <td>2003-12-26 13:00:00</td>
      <td>3</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>39</td>
      <td>2004-03-28 17:05:00</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>22</td>
      <td>2004-05-15 16:00:00</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>30</th>
      <td>217</td>
      <td>422</td>
      <td>2020-11-29 14:00:00</td>
      <td>4</td>
      <td>0</td>
    </tr>
    <tr>
      <th>31</th>
      <td>217</td>
      <td>552</td>
      <td>2021-02-21 14:00:00</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>32</th>
      <td>217</td>
      <td>1042</td>
      <td>2021-02-24 19:00:00</td>
      <td>3</td>
      <td>0</td>
    </tr>
    <tr>
      <th>33</th>
      <td>222</td>
      <td>217</td>
      <td>2021-04-25 16:15:00</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>34</th>
      <td>217</td>
      <td>218</td>
      <td>2020-11-07 16:15:00</td>
      <td>5</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
<p>566 rows × 5 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see that we have 500+ games to work with. That's more than enough given that we can extract many sequences per game.</p>
<p>Let's now use the <code>socceractions</code> functions to extract the data from and put them in the event data in <em>SPADL</em> format. More information about this standard format can be found in this <a href="https://dl.acm.org/doi/10.1145/3292500.3330758">paper</a>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># teams, players, events, actions = [], [], [], []</span>
<span class="c1"># for game in games_verbose:</span>
<span class="c1">#    # load data</span>
<span class="c1">#    teams.append(SBL.teams(game.game_id))</span>
<span class="c1">#    players.append(SBL.players(game.game_id))</span>
<span class="c1">#    game_events = SBL.events(game.game_id)</span>

<span class="c1">#    # convert data</span>
<span class="c1">#    spadl_actions = spadl.statsbomb.convert_to_actions(game_events,</span>
<span class="c1">#                                                       game.home_team_id)</span>
<span class="c1">#    spadl_actions[&quot;game_id&quot;] = game.game_id</span>
<span class="c1">#    events.append(game_events)</span>
<span class="c1">#    actions.append(spadl_actions)</span>

<span class="c1"># teams = pd.concat(teams).drop_duplicates(subset=&quot;team_id&quot;)</span>
<span class="c1"># players = pd.concat(players).drop_duplicates(subset=&quot;player_id&quot;)</span>
<span class="c1"># events = pd.concat(events)</span>
<span class="c1"># actions = pd.concat(actions)</span>

<span class="c1"># teams.to_pickle(os.path.join(data_path, &quot;teams.pkl&quot;))</span>
<span class="c1"># players.to_pickle(os.path.join(data_path,&quot;players.pkl&quot;))</span>
<span class="c1"># events.to_pickle(os.path.join(data_path,&quot;events.pkl&quot;))</span>
<span class="c1"># actions.to_pickle(os.path.join(data_path,&quot;spadl_actions.pkl&quot;))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The previous step may take some time, therefore it makes sense to save the objects and load them back when needed:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls <span class="o">{</span>data_path<span class="o">}</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>&#39;Copy of sequences.pkl&#39;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">teams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;teams.pkl&quot;</span><span class="p">))</span>
<span class="n">players</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;players.pkl&quot;</span><span class="p">))</span>
<span class="n">events</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;events.pkl&quot;</span><span class="p">))</span>
<span class="n">actions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;spadl_actions.pkl&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Prepare-sequence-data">Prepare sequence data<a class="anchor-link" href="#Prepare-sequence-data"> </a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Enrich-the-SPADL-actions">Enrich the <code>SPADL</code> actions<a class="anchor-link" href="#Enrich-the-SPADL-actions"> </a></h2><p>The standardization done when creating the <code>SPADL</code> <code>dataFrame</code> can benefit from some extra information available in the events data such as the possession number or the pattern of play.</p>
<p>On the other hand, we can also add some metadata to allow the user to better read visualise and understand the data.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">extra_info</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">events</span><span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">&quot;event_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;possession&quot;</span><span class="p">,</span>
            <span class="s2">&quot;possession_team_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;play_pattern_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;play_pattern_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;under_pressure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;counterpress&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">]</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;event_id&quot;</span><span class="p">:</span> <span class="s2">&quot;original_event_id&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">astype</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;possession&quot;</span><span class="p">:</span> <span class="s2">&quot;int64&quot;</span><span class="p">,</span>
            <span class="s2">&quot;possession_team_id&quot;</span><span class="p">:</span> <span class="s2">&quot;int64&quot;</span><span class="p">,</span>
            <span class="s2">&quot;play_pattern_id&quot;</span><span class="p">:</span> <span class="s2">&quot;int64&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1">## first, we add some game metadata</span>
<span class="n">full_actions</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">actions</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">games</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;game_day&quot;</span><span class="p">,</span> <span class="s2">&quot;venue&quot;</span><span class="p">,</span> <span class="s2">&quot;referee_id&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">),</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;game_id&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">spadl</span><span class="o">.</span><span class="n">actiontypes_df</span><span class="p">(),</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;type_id&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">spadl</span><span class="o">.</span><span class="n">results_df</span><span class="p">(),</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;result_id&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">spadl</span><span class="o">.</span><span class="n">bodyparts_df</span><span class="p">(),</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;bodypart_id&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">players</span><span class="p">[[</span><span class="s2">&quot;player_id&quot;</span><span class="p">,</span> <span class="s2">&quot;player_name&quot;</span><span class="p">,</span> <span class="s2">&quot;nickname&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="s2">&quot;player_id&quot;</span>
        <span class="p">),</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;player_id&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">teams</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;team_id&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">extra_info</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;original_event_id&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">full_actions</span><span class="p">[</span><span class="s2">&quot;is_home&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_actions</span><span class="p">[</span><span class="s2">&quot;team_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">full_actions</span><span class="p">[</span><span class="s2">&quot;home_team_id&quot;</span><span class="p">]</span>

<span class="c1">## check that we d</span>
<span class="k">assert</span> <span class="n">actions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">full_actions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">full_actions</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;spadl_full_actions.pkl&quot;</span><span class="p">))</span>

<span class="n">full_actions</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>game_id</th>
      <th>original_event_id</th>
      <th>period_id</th>
      <th>time_seconds</th>
      <th>team_id</th>
      <th>player_id</th>
      <th>start_x</th>
      <th>start_y</th>
      <th>end_x</th>
      <th>end_y</th>
      <th>type_id</th>
      <th>result_id</th>
      <th>bodypart_id</th>
      <th>action_id</th>
      <th>season_id</th>
      <th>competition_id</th>
      <th>competition_stage</th>
      <th>game_date</th>
      <th>home_team_id</th>
      <th>away_team_id</th>
      <th>home_score</th>
      <th>away_score</th>
      <th>type_name</th>
      <th>result_name</th>
      <th>bodypart_name</th>
      <th>player_name</th>
      <th>nickname</th>
      <th>team_name</th>
      <th>possession</th>
      <th>possession_team_id</th>
      <th>play_pattern_id</th>
      <th>play_pattern_name</th>
      <th>under_pressure</th>
      <th>counterpress</th>
      <th>is_home</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3752619</td>
      <td>fa5fba91-0000-4373-8df2-e96d3a64f54e</td>
      <td>1</td>
      <td>0.0</td>
      <td>129</td>
      <td>25878</td>
      <td>52.058824</td>
      <td>34.430380</td>
      <td>51.264706</td>
      <td>36.668354</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>44</td>
      <td>16</td>
      <td>Final</td>
      <td>2004-05-26 12:00:00</td>
      <td>129</td>
      <td>256</td>
      <td>0</td>
      <td>3</td>
      <td>pass</td>
      <td>success</td>
      <td>foot</td>
      <td>Ludovic Giuly</td>
      <td>None</td>
      <td>AS Monaco</td>
      <td>2.0</td>
      <td>129.0</td>
      <td>9.0</td>
      <td>From Kick Off</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3752619</td>
      <td>d6b4ca02-934c-48c3-ae05-ef7198b9fdf3</td>
      <td>1</td>
      <td>1.0</td>
      <td>129</td>
      <td>20130</td>
      <td>51.264706</td>
      <td>36.668354</td>
      <td>51.088235</td>
      <td>36.410127</td>
      <td>21</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>44</td>
      <td>16</td>
      <td>Final</td>
      <td>2004-05-26 12:00:00</td>
      <td>129</td>
      <td>256</td>
      <td>0</td>
      <td>3</td>
      <td>dribble</td>
      <td>success</td>
      <td>foot</td>
      <td>Fernando Morientes Sánchez</td>
      <td>Fernando Morientes</td>
      <td>AS Monaco</td>
      <td>2.0</td>
      <td>129.0</td>
      <td>9.0</td>
      <td>From Kick Off</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3752619</td>
      <td>c850b82b-63a3-4b21-a0d9-710d051e8108</td>
      <td>1</td>
      <td>1.0</td>
      <td>129</td>
      <td>20130</td>
      <td>51.088235</td>
      <td>36.410127</td>
      <td>41.029412</td>
      <td>11.792405</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>44</td>
      <td>16</td>
      <td>Final</td>
      <td>2004-05-26 12:00:00</td>
      <td>129</td>
      <td>256</td>
      <td>0</td>
      <td>3</td>
      <td>pass</td>
      <td>success</td>
      <td>foot</td>
      <td>Fernando Morientes Sánchez</td>
      <td>Fernando Morientes</td>
      <td>AS Monaco</td>
      <td>2.0</td>
      <td>129.0</td>
      <td>9.0</td>
      <td>From Kick Off</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3752619</td>
      <td>a7161093-9063-459c-a7e6-18d51a72bb52</td>
      <td>1</td>
      <td>3.0</td>
      <td>129</td>
      <td>26140</td>
      <td>41.029412</td>
      <td>11.792405</td>
      <td>59.647059</td>
      <td>7.058228</td>
      <td>21</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>44</td>
      <td>16</td>
      <td>Final</td>
      <td>2004-05-26 12:00:00</td>
      <td>129</td>
      <td>256</td>
      <td>0</td>
      <td>3</td>
      <td>dribble</td>
      <td>success</td>
      <td>foot</td>
      <td>Hugo Benjamín Ibarra</td>
      <td>Hugo Ibarra</td>
      <td>AS Monaco</td>
      <td>2.0</td>
      <td>129.0</td>
      <td>9.0</td>
      <td>From Kick Off</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3752619</td>
      <td>00b1730d-ada4-4021-b53e-cb81d030bfc9</td>
      <td>1</td>
      <td>6.0</td>
      <td>129</td>
      <td>26140</td>
      <td>59.647059</td>
      <td>7.058228</td>
      <td>63.970588</td>
      <td>9.382278</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>44</td>
      <td>16</td>
      <td>Final</td>
      <td>2004-05-26 12:00:00</td>
      <td>129</td>
      <td>256</td>
      <td>0</td>
      <td>3</td>
      <td>pass</td>
      <td>fail</td>
      <td>foot</td>
      <td>Hugo Benjamín Ibarra</td>
      <td>Hugo Ibarra</td>
      <td>AS Monaco</td>
      <td>2.0</td>
      <td>129.0</td>
      <td>9.0</td>
      <td>From Kick Off</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1250802</th>
      <td>3773477</td>
      <td>4a798266-43d7-4c9a-91d5-276cc5228b69</td>
      <td>2</td>
      <td>2972.0</td>
      <td>218</td>
      <td>6851</td>
      <td>68.823529</td>
      <td>64.556962</td>
      <td>37.676471</td>
      <td>57.068354</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>2235</td>
      <td>90</td>
      <td>11</td>
      <td>Regular Season</td>
      <td>2020-11-07 16:15:00</td>
      <td>217</td>
      <td>218</td>
      <td>5</td>
      <td>2</td>
      <td>pass</td>
      <td>success</td>
      <td>foot</td>
      <td>Aitor Ruibal García</td>
      <td>Aitor Ruibal</td>
      <td>Real Betis</td>
      <td>180.0</td>
      <td>218.0</td>
      <td>8.0</td>
      <td>From Keeper</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1250803</th>
      <td>3773477</td>
      <td>edd38889-aaed-45b8-8ad4-16718a477d66</td>
      <td>2</td>
      <td>2974.0</td>
      <td>217</td>
      <td>6826</td>
      <td>42.000000</td>
      <td>58.101266</td>
      <td>42.000000</td>
      <td>58.101266</td>
      <td>8</td>
      <td>1</td>
      <td>0</td>
      <td>2236</td>
      <td>90</td>
      <td>11</td>
      <td>Regular Season</td>
      <td>2020-11-07 16:15:00</td>
      <td>217</td>
      <td>218</td>
      <td>5</td>
      <td>2</td>
      <td>foul</td>
      <td>success</td>
      <td>foot</td>
      <td>Clément Lenglet</td>
      <td>None</td>
      <td>Barcelona</td>
      <td>180.0</td>
      <td>218.0</td>
      <td>8.0</td>
      <td>From Keeper</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1250804</th>
      <td>3773477</td>
      <td>6a5e2ead-5a23-4cc7-8f17-e2cc14e98a53</td>
      <td>2</td>
      <td>3002.0</td>
      <td>218</td>
      <td>41083</td>
      <td>48.970588</td>
      <td>62.577215</td>
      <td>6.529412</td>
      <td>34.688608</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>2237</td>
      <td>90</td>
      <td>11</td>
      <td>Regular Season</td>
      <td>2020-11-07 16:15:00</td>
      <td>217</td>
      <td>218</td>
      <td>5</td>
      <td>2</td>
      <td>freekick_crossed</td>
      <td>fail</td>
      <td>foot</td>
      <td>Rodrigo Sánchez Rodriguez</td>
      <td>Rodri</td>
      <td>Real Betis</td>
      <td>181.0</td>
      <td>218.0</td>
      <td>3.0</td>
      <td>From Free Kick</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1250805</th>
      <td>3773477</td>
      <td>09fcb776-16cd-41fc-82f5-387115a4f97e</td>
      <td>2</td>
      <td>3006.0</td>
      <td>217</td>
      <td>20055</td>
      <td>5.735294</td>
      <td>35.463291</td>
      <td>6.970588</td>
      <td>31.503797</td>
      <td>21</td>
      <td>1</td>
      <td>0</td>
      <td>2238</td>
      <td>90</td>
      <td>11</td>
      <td>Regular Season</td>
      <td>2020-11-07 16:15:00</td>
      <td>217</td>
      <td>218</td>
      <td>5</td>
      <td>2</td>
      <td>dribble</td>
      <td>success</td>
      <td>foot</td>
      <td>Marc-André ter Stegen</td>
      <td>Marc-André ter Stegen</td>
      <td>Barcelona</td>
      <td>181.0</td>
      <td>218.0</td>
      <td>3.0</td>
      <td>From Free Kick</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1250806</th>
      <td>3773477</td>
      <td>b2d664b0-975b-460a-9a88-c903990c4852</td>
      <td>2</td>
      <td>3009.0</td>
      <td>217</td>
      <td>20055</td>
      <td>6.970588</td>
      <td>31.503797</td>
      <td>12.088235</td>
      <td>31.073418</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>2239</td>
      <td>90</td>
      <td>11</td>
      <td>Regular Season</td>
      <td>2020-11-07 16:15:00</td>
      <td>217</td>
      <td>218</td>
      <td>5</td>
      <td>2</td>
      <td>pass</td>
      <td>success</td>
      <td>other</td>
      <td>Marc-André ter Stegen</td>
      <td>Marc-André ter Stegen</td>
      <td>Barcelona</td>
      <td>181.0</td>
      <td>218.0</td>
      <td>3.0</td>
      <td>From Free Kick</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>1250807 rows × 35 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-the-playing-sequences">Create the playing sequences<a class="anchor-link" href="#Create-the-playing-sequences"> </a></h2><p>Now that we have the standardized playing events, we can start preparing the tuple of playing sequence and targets.</p>
<p>The question we want to answer here is fairly simple: <em>What is the probability of a sequence of play to end up in a goal <strong>at the end of a possession</strong> ?</em></p>
<p>It is important to note few things at this stage:</p>
<ul>
<li>The target is known at the end of the possession and hence we do some sort of lookahead to assign the target (<code>1</code> for goal <code>0</code> otherwise).</li>
<li>Elements in the sequence are not equally spaced in time. It could be useful to add some features related to the time until start of possession in the feature space (i.e a new column in the sequence).</li>
<li>It is important to derive several training examples from one possession and not just pass the entire possession as one example. This may lead the model to associate 'goals' with a 'shot' as the final action to classify a sequence of play and miss important actions that happen beforehands.</li>
<li>Similar to sentences in NLP, sequences of play have different length and we may have to use <code>padding</code> and even take advantage of the <a href="https://docs.fast.ai/text.data.html#SortedDL">SortedDL</a> to form batches with similar lengths.</li>
</ul>
<p>The strategy adapted to form training examples is described below:</p>
<ul>
<li>We iterate over all games and possessions</li>
<li>For a given possession, we extract the target. As explained above, this is just a look ahead step to see if the final action of the possession resulted in a goal.</li>
<li>We sample random points in the sequence. A training example is formed by taking all the playing events up to the selected point. We should always include the full possession as an example.</li>
<li>Once the required number of examples is reached (for a given game/possession), we move to the next possession.</li>
</ul>
<p>This problem is expected to be (very) unbalanced as goals are rare events. We may have to deal with this with some sampling strategy when we fit our leanrer.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">game_poss</span> <span class="o">=</span> <span class="n">full_actions</span><span class="p">[[</span><span class="s2">&quot;game_id&quot;</span><span class="p">,</span> <span class="s2">&quot;possession&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="n">game_poss</span><span class="o">.</span><span class="n">game_id</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">game_poss</span><span class="o">.</span><span class="n">game_id</span><span class="p">,</span> <span class="n">downcast</span><span class="o">=</span><span class="s2">&quot;integer&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">PlayingData</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>

<span class="c1">## Columns to keep in sequence</span>
<span class="n">KEEP_COLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;period_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;time_seconds&quot;</span><span class="p">,</span>
    <span class="s2">&quot;start_x&quot;</span><span class="p">,</span>
    <span class="s2">&quot;start_y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;end_x&quot;</span><span class="p">,</span>
    <span class="s2">&quot;end_y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bodypart_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;player_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;player_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;team_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;team_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;is_home&quot;</span><span class="p">,</span>
    <span class="s2">&quot;play_pattern_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;under_pressure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;counterpress&quot;</span><span class="p">,</span>
    <span class="s2">&quot;seconds_since_poss&quot;</span><span class="p">,</span>
    <span class="s2">&quot;is_poss_team&quot;</span><span class="p">,</span>
    <span class="s2">&quot;result_name&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">_compute_target</span><span class="p">(</span><span class="n">poss_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute the sequence target&quot;&quot;&quot;</span>
    <span class="n">tgt_df</span> <span class="o">=</span> <span class="n">poss_df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">poss_df</span><span class="o">.</span><span class="n">result_name</span> <span class="o">==</span> <span class="s2">&quot;owngoal&quot;</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">poss_df</span><span class="p">[</span><span class="s2">&quot;type_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;shot&quot;</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">poss_df</span><span class="p">[</span><span class="s2">&quot;result_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot;goal&quot;</span> <span class="k">if</span> <span class="n">tgt_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;no_goal&quot;</span>


<span class="k">def</span> <span class="nf">_get_playing_seq</span><span class="p">(</span><span class="n">ti</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">poss_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlayingData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Format the playing sequence&quot;&quot;&quot;</span>
    <span class="n">seq_def</span> <span class="o">=</span> <span class="n">poss_df</span><span class="p">[</span><span class="n">poss_df</span><span class="o">.</span><span class="n">time_seconds</span> <span class="o">&lt;=</span> <span class="n">ti</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">## add an id for the sequence</span>
    <span class="n">seq_def</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">seq_def</span><span class="p">[</span><span class="s2">&quot;game_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seq_def</span><span class="p">[</span><span class="s2">&quot;original_event_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seq_def</span><span class="p">[</span><span class="s2">&quot;original_event_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">seq_def</span><span class="p">[</span><span class="n">KEEP_COLS</span><span class="p">],</span> <span class="n">target</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_form_examples</span><span class="p">(</span>
    <span class="n">game_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">poss_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_examples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PlayingData</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create Training example for given possession in a game</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    game_id: int</span>
<span class="sd">      game identifier</span>
<span class="sd">    poss_id: int</span>
<span class="sd">      possession number</span>
<span class="sd">    max_examples: int</span>
<span class="sd">      maximum total number of examples</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[PlayingData]</span>
<span class="sd">      Every tuple is a `pandas DataFrame` (giving the sequence info)</span>
<span class="sd">      and an &#39;str` (target `goal`/`no_goal`)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## extract the fraction of data we care about</span>
    <span class="n">_poss_df</span> <span class="o">=</span> <span class="n">full_actions</span><span class="p">[</span>
        <span class="p">(</span><span class="n">full_actions</span><span class="o">.</span><span class="n">game_id</span> <span class="o">==</span> <span class="n">game_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">full_actions</span><span class="o">.</span><span class="n">possession</span> <span class="o">==</span> <span class="n">poss_id</span><span class="p">)</span>
    <span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;time_seconds&quot;</span><span class="p">])</span>
    <span class="n">st_time</span><span class="p">,</span> <span class="n">en_time</span><span class="p">,</span> <span class="n">period_id</span><span class="p">,</span> <span class="n">poss_team_id</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_poss_df</span><span class="p">[</span><span class="s2">&quot;time_seconds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">_poss_df</span><span class="p">[</span><span class="s2">&quot;time_seconds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
        <span class="n">_poss_df</span><span class="o">.</span><span class="n">period_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">_poss_df</span><span class="o">.</span><span class="n">possession_team_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">poss_df</span> <span class="o">=</span> <span class="n">full_actions</span><span class="p">[</span>
        <span class="p">(</span><span class="n">full_actions</span><span class="o">.</span><span class="n">game_id</span> <span class="o">==</span> <span class="n">game_id</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">full_actions</span><span class="o">.</span><span class="n">period_id</span> <span class="o">==</span> <span class="n">period_id</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">full_actions</span><span class="o">.</span><span class="n">time_seconds</span> <span class="o">&gt;=</span> <span class="n">st_time</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">full_actions</span><span class="o">.</span><span class="n">time_seconds</span> <span class="o">&lt;=</span> <span class="n">en_time</span><span class="p">)</span>
    <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">poss_df</span><span class="p">[</span><span class="s2">&quot;seconds_since_poss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poss_df</span><span class="p">[</span><span class="s2">&quot;time_seconds&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">st_time</span>
    <span class="n">poss_df</span><span class="p">[</span><span class="s2">&quot;is_poss_team&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poss_df</span><span class="p">[</span><span class="s2">&quot;team_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">poss_team_id</span>

    <span class="c1">## compute target</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">_compute_target</span><span class="p">(</span><span class="n">poss_df</span><span class="p">)</span>

    <span class="c1">## sample the appropriate number of events</span>
    <span class="n">time_events</span> <span class="o">=</span> <span class="n">poss_df</span><span class="p">[</span><span class="s2">&quot;time_seconds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_events</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">max_examples</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">time_events</span> <span class="o">=</span> <span class="n">time_events</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time_events</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">time_events</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">max_examples</span><span class="p">)</span>

    <span class="c1">## create the list of tuples</span>
    <span class="k">return</span> <span class="n">L</span><span class="p">(</span><span class="n">_get_playing_seq</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">poss_df</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">time_events</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">poss_ex</span> <span class="o">=</span> <span class="n">_form_examples</span><span class="p">(</span><span class="n">game_id</span><span class="o">=</span><span class="mi">303696</span><span class="p">,</span> <span class="n">poss_id</span><span class="o">=</span><span class="mi">19</span><span class="p">)</span>
<span class="n">poss_ex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(                                                       _id  period_id  \
 1132366  303696_0a675ea0-1fd4-4dd5-aa2d-e740554092db_fd...          1   
 1132367  303696_0a675ea0-1fd4-4dd5-aa2d-e740554092db_fd...          1   
 1132368  303696_0a675ea0-1fd4-4dd5-aa2d-e740554092db_fd...          1   
 1132369  303696_0a675ea0-1fd4-4dd5-aa2d-e740554092db_fd...          1   
 1132370  303696_0a675ea0-1fd4-4dd5-aa2d-e740554092db_fd...          1   
 
          time_seconds    start_x    start_y      end_x      end_y type_name  \
 1132366         508.0  13.941176  18.678481  13.941176  18.678481    tackle   
 1132367         508.0  13.941176  18.678481  31.852941   5.594937   dribble   
 1132368         512.0  31.852941   5.594937  36.882353  16.268354      pass   
 1132369         513.0  36.882353  16.268354  35.117647  16.096203   dribble   
 1132370         513.0  35.117647  16.096203  28.676471  17.387342      pass   
 
         bodypart_name  player_id           player_name  team_id  \
 1132366          foot       5198  Diego da Silva Costa      212   
 1132367          foot       5198  Diego da Silva Costa      212   
 1132368          foot       5198  Diego da Silva Costa      212   
 1132369          foot       6381  Saúl Ñíguez Esclapez      212   
 1132370          foot       6381  Saúl Ñíguez Esclapez      212   
 
                team_name  is_home play_pattern_name under_pressure  \
 1132366  Atlético Madrid    False      Regular Play           True   
 1132367  Atlético Madrid    False      Regular Play           True   
 1132368  Atlético Madrid    False      Regular Play           True   
 1132369  Atlético Madrid    False      Regular Play          False   
 1132370  Atlético Madrid    False      Regular Play          False   
 
         counterpress  seconds_since_poss  is_poss_team result_name  
 1132366         True                 0.0          True     success  
 1132367        False                 0.0          True     success  
 1132368        False                 4.0          True     success  
 1132369        False                 5.0          True     success  
 1132370        False                 5.0          True     success  ,
 &#39;no_goal&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see that every sequence is formed of 3 types (actually 2 as binary features can also be seen as categorical).</p>
<ul>
<li><strong>continuous</strong> features:<ul>
<li><code>seconds_since_poss</code>: <em>float</em> time in seconds since the start of the possession</li>
<li><code>time_seconds</code>: <em>float</em> time in seconds since the start of the half</li>
<li><code>start_x</code>, <code>start_y</code>, <code>end_x</code>, <code>end_y</code>: <em>float</em> start and end x,y location of an event.</li>
</ul>
</li>
<li><strong>binary</strong> features:<ul>
<li><code>period_id</code> <em>int</em> either first(1) or second (2) period of a game.</li>
<li><code>is_home</code>: <em>bool</em> is the team in possession playing at home?</li>
<li><code>under_pressure</code>: <em>bool</em> is the action peformed under pressure?</li>
<li><code>counterpress</code>: <em>bool</em> is the action part if counter-press?</li>
<li><code>is_poss_team</code>: <em>bool</em> is the player performing the action part of the team in possession?</li>
</ul>
</li>
<li><strong>categorical</strong> (non binary) features:<ul>
<li><code>type_name</code>: <em>str</em> type of action peformed</li>
<li><code>bodypart_name</code></li>
<li><code>player_id</code>/<code>player_name</code>: <em>int</em>/<em>str</em>: player id and name</li>
<li><code>team_id</code>/<code>team_name</code>: <em>int</em>/<em>str</em>: player's team id and name</li>
<li><code>play_pattern_name</code>: <em>str</em> pattern of play</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have the function to create the Training tuple (although we may need to pre-process it before training), we can loop over all the couples game/possession and save the results in a large list. Note that every game/sequence produces a number of examples.</p>
<p>The data is stored in 2 seperate dictionaries:</p>
<ul>
<li><code>sequence_data</code>: a <code>DataFrame</code> describing the playing sequence</li>
<li><code>target_data</code> <code>str</code> whether the sequence ended with a <code>goal</code> or <code>no_goal</code>
Note that both dictionaries will use the key ids which is unique for every 
example.</li>
</ul>
<p>In order to reduce computation time, we will only compute sequences we didn't 
compute before.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;sequences.pkl&quot;</span><span class="p">)):</span>
    <span class="n">sequence_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;sequences.pkl&quot;</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
    <span class="n">target_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;targets.pkl&quot;</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">sequence_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">target_data</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">## get computed game_ids</span>
<span class="n">computed_gm_ids</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sequence_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">game_poss</span> <span class="o">=</span> <span class="n">game_poss</span><span class="p">[</span><span class="o">~</span><span class="n">game_poss</span><span class="o">.</span><span class="n">game_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">computed_gm_ids</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Working on: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">game_poss</span><span class="o">.</span><span class="n">game_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; games ...&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Working on: 282 games ...
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">game</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">progressbar</span><span class="o">.</span><span class="n">progressbar</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">game_poss</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()))):</span>
    <span class="n">poss_ex</span> <span class="o">=</span> <span class="n">_form_examples</span><span class="p">(</span><span class="n">game_id</span><span class="o">=</span><span class="n">game</span><span class="o">.</span><span class="n">game_id</span><span class="p">,</span> <span class="n">poss_id</span><span class="o">=</span><span class="n">game</span><span class="o">.</span><span class="n">possession</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">poss_ex</span><span class="p">:</span>
        <span class="n">_id</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sequence_data</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">target_data</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sequence_data</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;sequences.pkl&quot;</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">target_data</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;targets.pkl&quot;</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100% (51227 of 51227) |##################| Elapsed Time: 6:05:41 Time:  6:05:41
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

