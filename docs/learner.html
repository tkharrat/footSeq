---

title: Model


keywords: fastai
sidebar: home_sidebar



nb_path: "02_learner.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 02_learner.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="kn">from</span> <span class="nn">IPython.core.debugger</span> <span class="kn">import</span> <span class="n">set_trace</span>
<span class="kn">from</span> <span class="nn">IPython.utils</span> <span class="kn">import</span> <span class="n">traitlets</span> <span class="k">as</span> <span class="n">_traitlets</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1><center> Learner </center></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this module, we define the model architecture that we will use in our learner. It will be based on <code>tsai</code> models with a simple tweak: ability to handle categorical features.</p>
<p>The strategy to build our model is fairly simple:</p>
<ul>
<li>apply a specific 'Embedding` layer to each categorical feature</li>
<li>concatenate the outcome of the embedding layers with the continuous features</li>
<li>pass the resulting tensor to a <code>tsai</code> existing model
The first 2 steps can be handled by the <em>head</em> of the network which can be seen as a layer.</li>
</ul>
<p>Once the architecture defined, we can define our learner in the usual way and benefit from <code>fastai</code> training loop.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">default_device</span><span class="p">()</span>
<span class="n">computer_setup</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">footSeq.config.mongo</span> <span class="kn">import</span> <span class="n">mongo_init</span>

<span class="n">mongo_init</span><span class="p">(</span><span class="s2">&quot;prod_atlas&quot;</span><span class="p">)</span>

<span class="n">data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/sequences&quot;</span><span class="p">)</span>
<span class="n">metadata_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">)</span>
<span class="n">files_list_path</span> <span class="o">=</span> <span class="n">metadata_path</span> <span class="o">/</span> <span class="s2">&quot;file_list.pkl&quot;</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">files_list_path</span><span class="p">):</span>
    <span class="n">all_files</span> <span class="o">=</span> <span class="n">load_pickle</span><span class="p">(</span><span class="n">files_list_path</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">files_db</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;file_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">progressbar</span><span class="p">(</span><span class="n">PossessionMetadata</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s2">&quot;file_id&quot;</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">disk_files</span> <span class="o">=</span> <span class="n">data_path</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">file_exts</span><span class="o">=</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
    <span class="n">all_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">files_db</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">disk_files</span><span class="p">))</span>
    <span class="n">save_pickle</span><span class="p">(</span><span class="n">files_list_path</span><span class="p">,</span> <span class="n">all_files</span><span class="p">)</span>

<span class="n">all_files</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">all_files</span><span class="p">)</span><span class="o">.</span><span class="n">shuffle</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">total_files</span> <span class="o">=</span> <span class="mi">1000000</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">all_files</span><span class="p">[:</span><span class="n">total_files</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">no_goal_prop</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">valid_pct</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">44</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_goals</span><span class="p">,</span> <span class="n">test_goals</span><span class="p">,</span> <span class="n">no_goals</span> <span class="o">=</span> <span class="n">pick_files_from_db</span><span class="p">(</span><span class="n">total_n_files</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span> <span class="n">goal_prop</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">no_goal_prop</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">n_no_goals_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">train_goals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">no_goal_prop</span><span class="p">)</span>
<span class="n">files_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_goals</span><span class="p">,</span> <span class="n">no_goals</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_no_goals_train</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1">## test files</span>
<span class="n">n_no_goals_test</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_goals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">no_goal_prop</span><span class="p">)</span>
<span class="n">no_goals_left</span> <span class="o">=</span> <span class="n">no_goals</span><span class="p">[</span><span class="o">~</span><span class="n">no_goals</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">files_info</span><span class="o">.</span><span class="n">file</span><span class="p">)]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_no_goals_test</span><span class="p">)</span>
<span class="n">test_files_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">test_goals</span><span class="p">,</span> <span class="n">no_goals_left</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">labels</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">files_info</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We only want to keep files with at least 2 playing steps:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">files_info</span> <span class="o">=</span> <span class="n">files_info</span><span class="p">[</span><span class="n">files_info</span><span class="o">.</span><span class="n">nSteps</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">files_info</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to test our different examples, let's prepare a batch of data:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;standart_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;possession_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attack_status_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attack_type_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;under_pressure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;high_speed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;result_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;action_subtype_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;generic_action_type_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;body_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;is_poss_team&quot;</span><span class="p">,</span>
    <span class="s2">&quot;is_att_team&quot;</span><span class="p">,</span>
    <span class="s2">&quot;touches&quot;</span><span class="p">,</span>
    <span class="s2">&quot;shot_type&quot;</span><span class="p">,</span>
    <span class="s2">&quot;shot_handling&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">cont_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;start_x&quot;</span><span class="p">,</span>
    <span class="s2">&quot;start_y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;end_x&quot;</span><span class="p">,</span>
    <span class="s2">&quot;end_y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;time_seconds&quot;</span><span class="p">,</span>
    <span class="s2">&quot;seconds_since_poss&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">files</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">files_info</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>


<span class="c1">## splits</span>
<span class="n">splits_files</span> <span class="o">=</span> <span class="n">goal_splitter</span><span class="p">(</span>
    <span class="n">files_info_df</span><span class="o">=</span><span class="n">files_info</span><span class="p">,</span> <span class="n">no_goal_prop</span><span class="o">=</span><span class="n">no_goal_prop</span><span class="p">,</span> <span class="n">valid_pct</span><span class="o">=</span><span class="n">valid_pct</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span>
<span class="p">)</span>

<span class="n">procs</span> <span class="o">=</span> <span class="p">[</span><span class="n">FillMissing</span><span class="p">,</span> <span class="n">Categorify</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">]</span>
<span class="n">foot_tfm</span> <span class="o">=</span> <span class="n">FootSeqTransform</span><span class="p">(</span>
    <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
    <span class="n">splits</span><span class="o">=</span><span class="n">splits_files</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
    <span class="n">procs</span><span class="o">=</span><span class="n">procs</span><span class="p">,</span>
    <span class="n">cat_names</span><span class="o">=</span><span class="n">cat_names</span><span class="p">,</span>
    <span class="n">cont_names</span><span class="o">=</span><span class="n">cont_names</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1">## to-tensor transform</span>
<span class="n">to_tsr</span> <span class="o">=</span> <span class="n">FootSeqToTensor</span><span class="p">(</span>
    <span class="n">cat_names</span><span class="o">=</span><span class="n">cat_names</span><span class="p">,</span>
    <span class="n">cont_names</span><span class="o">=</span><span class="n">cont_names</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
    <span class="n">base_path</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span>
    <span class="n">max_len</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1">## tfmdlist</span>
<span class="n">tls</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="p">[</span><span class="n">foot_tfm</span><span class="p">,</span> <span class="n">to_tsr</span><span class="p">],</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits_files</span><span class="p">)</span>

<span class="c1">## params for datalodaers</span>
<span class="n">train_seq_lens</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">get_sequence_len</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="n">splits_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">valid_seq_lens</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">get_sequence_len</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="n">splits_files</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>


<span class="c1">## pass the training dataset sequence lengths to SortedDL</span>
<span class="n">srtd_dl</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">SortedDL</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">train_seq_lens</span><span class="p">)</span>

<span class="c1">## Pass the validation dataset seq lengths</span>
<span class="n">dl_kwargs</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{</span><span class="s2">&quot;val_res&quot;</span><span class="p">:</span> <span class="n">valid_seq_lens</span><span class="p">}]</span>

<span class="c1">## re-initialise dataloaders</span>
<span class="n">srtd_dls</span> <span class="o">=</span> <span class="n">tls</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span>
    <span class="n">bs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">before_batch</span><span class="o">=</span><span class="n">pad_seq</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="n">srtd_dl</span><span class="p">,</span> <span class="n">dl_kwargs</span><span class="o">=</span><span class="n">dl_kwargs</span>
<span class="p">)</span>
<span class="n">srtd_batch</span> <span class="o">=</span> <span class="n">srtd_dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>

<span class="n">srtd_batch</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Embedding">Embedding<a class="anchor-link" href="#Embedding"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Embedding" class="doc_header"><code>class</code> <code>Embedding</code><a href="https://github.com/fastai/fastai/tree/master/fastai/layers.py#L287" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Embedding</code>(<strong><code>ni</code></strong>, <strong><code>nf</code></strong>, <strong><code>std</code></strong>=<em><code>0.01</code></em>) :: <a href="/footSeq/learner.html#Embedding"><code>Embedding</code></a></p>
</blockquote>
<p>Embedding layer with truncated normal initialization</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MultiEmbedding" class="doc_header"><code>class</code> <code>MultiEmbedding</code><a href="https://github.com/timeseriesAI/tsai/tree/main/tsai/models/layers.py#L1037" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MultiEmbedding</code>(<strong><code>c_in</code></strong>, <strong><code>n_embeds</code></strong>, <strong><code>embed_dims</code></strong>=<em><code>None</code></em>, <strong><code>cat_pos</code></strong>=<em><code>None</code></em>, <strong><code>std</code></strong>=<em><code>0.01</code></em>, <strong><code>padding_idxs</code></strong>=<em><code>None</code></em>) :: <code>Module</code></p>
</blockquote>
<p>Same as <code>nn.Module</code>, but no need for subclasses to call <code>super().__init__</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to test this layer, we need to find the vocabulary size of each categorical variable and pass it in <code>n_embeds</code>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n_embeds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tls</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tls</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">cat_names</span><span class="p">]</span>
<span class="p">(</span><span class="n">tls</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">cat_names</span><span class="p">,</span> <span class="n">n_embeds</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's initialize the layer and check that it works as expected:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n_cont</span> <span class="o">=</span> <span class="n">srtd_batch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">multi_em</span> <span class="o">=</span> <span class="n">MultiEmbedding</span><span class="p">(</span><span class="n">n_embeds</span><span class="o">=</span><span class="n">n_embeds</span><span class="p">,</span> <span class="n">n_cont</span><span class="o">=</span><span class="n">n_cont</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">tsr_em</span> <span class="o">=</span> <span class="n">multi_em</span><span class="p">(</span><span class="n">srtd_batch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">srtd_batch</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span>
    <span class="n">tsr_em</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">L</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">multi_em</span><span class="o">.</span><span class="n">cat_embed</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">n_cont</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's investigate how we can use the <code>padding_idx</code> option. This can be very useful to avoid training useless weight corresponding to padding values. Let's first create a batch with some padded values:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reg_dls</span> <span class="o">=</span> <span class="n">tls</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">before_batch</span><span class="o">=</span><span class="n">pad_seq</span><span class="p">)</span>
<span class="n">padded_batch</span> <span class="o">=</span> <span class="n">reg_dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">padded_batch</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">multi_em_pad</span> <span class="o">=</span> <span class="n">MultiEmbedding</span><span class="p">(</span><span class="n">n_embeds</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_cont</span><span class="o">=</span><span class="n">n_cont</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">tsr_em</span> <span class="o">=</span> <span class="n">multi_em_pad</span><span class="p">(</span><span class="n">padded_batch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">padded_batch</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">tsr_em</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Notice how the dimension with all zeros (the default padding index) are also filled in with all zeros in the resulting tensor.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Full-Architecture">Full Architecture<a class="anchor-link" href="#Full-Architecture"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we are ready to plug in the embedding to any <code>tsai</code> learner. Our architecture is fairly straightforward:</p>
<ul>
<li><code>head</code> is the head of the network and runs the data through the <code>multiEmbedding</code> layer</li>
<li><code>body</code> takes the output of <code>head</code> and run it through the desired architecture selected by the user in <code>ts_arch</code></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MixedSeqModel" class="doc_header"><code>class</code> <code>MixedSeqModel</code><a href="https://github.com/tkharrat/footSeq/tree/master/footSeq/model/learner.py#L139" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MixedSeqModel</code>(<strong><code>arch</code></strong>:<code>Module</code>, <strong><code>n_cont</code></strong>:<code>int</code>, <strong><code>c_out</code></strong>:<code>int</code>, <strong><code>embded_config</code></strong>:<code>dict</code>=<em><code>None</code></em>, <strong><code>c_in</code></strong>=<em><code>None</code></em>, <strong><code>seq_len</code></strong>=<em><code>None</code></em>, <strong><code>d</code></strong>=<em><code>None</code></em>, <strong><code>dls</code></strong>=<em><code>None</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>, <strong><code>pretrained</code></strong>=<em><code>False</code></em>, <strong><code>weights_path</code></strong>=<em><code>None</code></em>, <strong><code>exclude_head</code></strong>=<em><code>True</code></em>, <strong><code>cut</code></strong>=<em><code>-1</code></em>, <strong><code>init</code></strong>=<em><code>None</code></em>, <strong><code>arch_config</code></strong>=<em><code>{}</code></em>) :: <code>Module</code></p>
</blockquote>
<p>Sequence model with an embedding head.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tsai.models.RNN_FCN</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">n_cont</span> <span class="o">=</span> <span class="n">padded_batch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">## select the architecture</span>
<span class="n">ts_model</span> <span class="o">=</span> <span class="n">LSTM_FCN</span>
<span class="n">ts_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bidirectional&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;rnn_layers&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;shuffle&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

<span class="c1">## LSTM</span>
<span class="c1">##ts_model = LSTM</span>
<span class="c1">##ts_args = {&quot;n_layers&quot;:2, &quot;bidirectional&quot;:True}</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">MixedSeqModel</span><span class="p">(</span>
    <span class="n">arch</span><span class="o">=</span><span class="n">ts_model</span><span class="p">,</span>
    <span class="n">n_cont</span><span class="o">=</span><span class="n">n_cont</span><span class="p">,</span>
    <span class="n">c_out</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">embded_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;n_embeds&quot;</span><span class="p">:</span> <span class="n">n_embeds</span><span class="p">,</span> <span class="s2">&quot;embed_p&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="o">**</span><span class="n">ts_args</span>
<span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">model</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="p">(</span><span class="n">padded_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">padded_batch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">padded_batch</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Learner">Learner<a class="anchor-link" href="#Learner"> </a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Defining a learner at this stage is straightforward, we just need to decide on the appropriate loss function to use, pass the <code>dataloaders</code> and the metrics we want to track. Moreover, the <code>tsai</code> <code>ts_learner</code> function provides a great interface that we could extend to meet our purposes:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Specific-class-for-the-Learner">Specific class for the <code>Learner</code><a class="anchor-link" href="#Specific-class-for-the-Learner"> </a></h2><p>We define a specific class <a href="/footSeq/learner.html#MixedSeqLearner"><code>MixedSeqLearner</code></a> that knows how to predict the sequence and how to show results:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MixedSeqLearner" class="doc_header"><code>class</code> <code>MixedSeqLearner</code><a href="https://github.com/tkharrat/footSeq/tree/master/footSeq/model/learner.py#L198" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MixedSeqLearner</code>(<strong><code>dls</code></strong>, <strong><code>model</code></strong>, <strong><code>loss_func</code></strong>=<em><code>None</code></em>, <strong><code>opt_func</code></strong>=<em><code>Adam</code></em>, <strong><code>lr</code></strong>=<em><code>0.001</code></em>, <strong><code>splitter</code></strong>=<em><code>trainable_params</code></em>, <strong><code>cbs</code></strong>=<em><code>None</code></em>, <strong><code>metrics</code></strong>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>None</code></em>, <strong><code>model_dir</code></strong>=<em><code>'models'</code></em>, <strong><code>wd</code></strong>=<em><code>None</code></em>, <strong><code>wd_bn_bias</code></strong>=<em><code>False</code></em>, <strong><code>train_bn</code></strong>=<em><code>True</code></em>, <strong><code>moms</code></strong>=<em><code>(0.95, 0.85, 0.95)</code></em>) :: <code>Learner</code></p>
</blockquote>
<p><code>Learner</code> for mixed sequence data</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="mixed_seq_learner" class="doc_header"><code>mixed_seq_learner</code><a href="https://github.com/tkharrat/footSeq/tree/master/footSeq/model/learner.py#L213" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>mixed_seq_learner</code>(<strong><code>arch</code></strong>:<code>Module</code>, <strong><code>n_cont</code></strong>:<code>int</code>, <strong><code>c_out</code></strong>:<code>int</code>, <strong><code>embded_config</code></strong>:<code>dict</code>=<em><code>None</code></em>, <strong><code>dls</code></strong>=<em><code>None</code></em>, <strong><code>splitter</code></strong>=<em><code>trainable_params</code></em>, <strong><code>loss_func</code></strong>=<em><code>None</code></em>, <strong><code>opt_func</code></strong>=<em><code>Adam</code></em>, <strong><code>lr</code></strong>=<em><code>0.001</code></em>, <strong><code>cbs</code></strong>=<em><code>None</code></em>, <strong><code>metrics</code></strong>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>None</code></em>, <strong><code>model_dir</code></strong>=<em><code>'models'</code></em>, <strong><code>wd</code></strong>=<em><code>None</code></em>, <strong><code>wd_bn_bias</code></strong>=<em><code>False</code></em>, <strong><code>train_bn</code></strong>=<em><code>True</code></em>, <strong><code>moms</code></strong>=<em><code>(0.95, 0.85, 0.95)</code></em>, <strong><code>c_in</code></strong>=<em><code>None</code></em>, <strong><code>seq_len</code></strong>=<em><code>None</code></em>, <strong><code>d</code></strong>=<em><code>None</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>, <strong><code>pretrained</code></strong>=<em><code>False</code></em>, <strong><code>weights_path</code></strong>=<em><code>None</code></em>, <strong><code>exclude_head</code></strong>=<em><code>True</code></em>, <strong><code>cut</code></strong>=<em><code>-1</code></em>, <strong><code>init</code></strong>=<em><code>None</code></em>, <strong><code>arch_config</code></strong>=<em><code>{}</code></em>)</p>
</blockquote>
<p>Interface to create a <code>Learner</code> for sequences with continuous and categorical features</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>arch: Module
    one of tsai Model architectures accepted by <code>build_ts_model()</code>
c_out: int
    number of output layers
n_cont: int
    number of continuous features
embed_config: dict
    all parameters accepted by the <a href="/footSeq/learner.html#MultiEmbedding"><code>MultiEmbedding</code></a> layer</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>fastai.Learner
    Learner object with the <a href="/footSeq/learner.html#MixedSeqModel"><code>MixedSeqModel</code></a> model architecture</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Useful-Learner-methods">Useful Learner methods<a class="anchor-link" href="#Useful-Learner-methods"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Predict-the-full-possession">Predict the full possession<a class="anchor-link" href="#Predict-the-full-possession"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We are particularly interested in predicting how the probability of scoring changes as the sequence progresses: In order to do that, we need to sort the sequences in acending order and produce the probabilities progressively:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="MixedSeqLearner.predict_poss" class="doc_header"><code>MixedSeqLearner.predict_poss</code><a href="https://github.com/tkharrat/footSeq/tree/master/footSeq/model/learner.py#L302" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>MixedSeqLearner.predict_poss</code>(<strong><code>seq_df</code></strong>:<code>DataFrame</code>, <strong><code>verbose</code></strong>:<code>bool</code>=<em><code>False</code></em>)</p>
</blockquote>
<p>Predict possession outcome probability in a sequentiel way</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Predict-an-entire-game">Predict an entire game<a class="anchor-link" href="#Predict-an-entire-game"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The next step is to be able to predict an entire game. The strategy is the following:</p>
<ul>
<li>extract the data from the database</li>
<li>predict the possessions one by one</li>
<li>concatenate the data by row</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="MixedSeqLearner.predict_game" class="doc_header"><code>MixedSeqLearner.predict_game</code><a href="https://github.com/tkharrat/footSeq/tree/master/footSeq/model/learner.py#L346" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>MixedSeqLearner.predict_game</code>(<strong><code>game_id</code></strong>:<code>int</code>, <strong><code>match_df</code></strong>:<code>DataFrame</code>=<em><code>None</code></em>, <strong><code>save</code></strong>:<code>bool</code>=<em><code>False</code></em>)</p>
</blockquote>
<p>Predict (all the possessions in) a game</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Save-and-Load">Save and Load<a class="anchor-link" href="#Save-and-Load"> </a></h2><p>Finally, we provide a function to load a previously saved learner:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="MixedSeqLearner.save_all" class="doc_header"><code>MixedSeqLearner.save_all</code><a href="https://github.com/tkharrat/footSeq/tree/master/footSeq/model/learner.py#L439" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>MixedSeqLearner.save_all</code>(<strong><code>path</code></strong>=<em><code>'export'</code></em>, <strong><code>dls_fname</code></strong>=<em><code>'dls'</code></em>, <strong><code>model_fname</code></strong>=<em><code>'model'</code></em>, <strong><code>learner_fname</code></strong>=<em><code>'learner'</code></em>, <strong><code>do_save_dls</code></strong>=<em><code>True</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_all" class="doc_header"><code>load_all</code><a href="https://github.com/timeseriesAI/tsai/tree/main/tsai/learner.py#L76" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_all</code>(<strong><code>path</code></strong>=<em><code>'export'</code></em>, <strong><code>dls_fname</code></strong>=<em><code>'dls'</code></em>, <strong><code>model_fname</code></strong>=<em><code>'model'</code></em>, <strong><code>learner_fname</code></strong>=<em><code>'learner'</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>, <strong><code>pickle_module</code></strong>=<em><code>pickle</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Define-and-Train-a-learner">Define and Train a learner<a class="anchor-link" href="#Define-and-Train-a-learner"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="From-scratch">From scratch<a class="anchor-link" href="#From-scratch"> </a></h3><p>Let's define a learner now with the <code>LSTM_FCN</code> architecture and find an appropriate learning rate:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.metrics</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">n_cont</span> <span class="o">=</span> <span class="n">padded_batch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">## prepare dataloaders</span>
<span class="n">srtd_dls</span> <span class="o">=</span> <span class="n">tls</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span>
    <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">before_batch</span><span class="o">=</span><span class="n">pad_seq</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="n">srtd_dl</span><span class="p">,</span> <span class="n">dl_kwargs</span><span class="o">=</span><span class="n">dl_kwargs</span>
<span class="p">)</span>

<span class="c1">## select the architecture</span>
<span class="n">ts_model</span> <span class="o">=</span> <span class="n">LSTM_FCN</span>
<span class="n">ts_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bidirectional&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;rnn_layers&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;shuffle&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">ts_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;bidir-</span><span class="si">{</span><span class="n">ts_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bidirectional&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;layers-</span><span class="si">{</span><span class="n">ts_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rnn_layers&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;no_goal_prop-</span><span class="si">{</span><span class="n">no_goal_prop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;full_data&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1">## create directory if it does not exist</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./models&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">model_name</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./models&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">model_name</span><span class="p">)</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">mixed_seq_learner</span><span class="p">(</span>
    <span class="n">arch</span><span class="o">=</span><span class="n">ts_model</span><span class="p">,</span>
    <span class="n">n_cont</span><span class="o">=</span><span class="n">n_cont</span><span class="p">,</span>
    <span class="n">c_out</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">embded_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;n_embeds&quot;</span><span class="p">:</span> <span class="n">n_embeds</span><span class="p">,</span> <span class="s2">&quot;embed_p&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="n">dls</span><span class="o">=</span><span class="n">srtd_dls</span><span class="p">,</span>
    <span class="n">loss_func</span><span class="o">=</span><span class="n">CrossEntropyLossFlat</span><span class="p">(),</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">],</span>
    <span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">),</span>
    <span class="n">model_dir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./models&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">model_name</span><span class="p">,</span>
    <span class="o">**</span><span class="n">ts_args</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lr_</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can train the learner for a number of cycles:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n_cycles</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="n">n_cycles</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="n">lr_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cbs</span><span class="o">=</span><span class="n">SaveModelCallback</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">model_name</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, we save the best learner using the <code>save_all()</code> method:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">save_all</span><span class="p">(</span>
    <span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./models&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">model_name</span><span class="p">,</span>
    <span class="n">dls_fname</span><span class="o">=</span><span class="s2">&quot;dls&quot;</span><span class="p">,</span>
    <span class="n">model_fname</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span>
    <span class="n">learner_fname</span><span class="o">=</span><span class="s2">&quot;learner&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Predict-Unseen-Sequences">Predict Unseen Sequences<a class="anchor-link" href="#Predict-Unseen-Sequences"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Predict-from-files">Predict from files<a class="anchor-link" href="#Predict-from-files"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can now compute some predictions on some files. We will select <code>n_ex</code> sequences ending with a goal and the same number ending in no-goal:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n_ex</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">test_files</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">test_goals</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_ex</span><span class="p">)[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">no_goals</span><span class="p">[</span><span class="o">~</span><span class="n">no_goals</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">files_info</span><span class="o">.</span><span class="n">file</span><span class="p">)]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_ex</span><span class="p">)[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Visualize-results">Visualize results<a class="anchor-link" href="#Visualize-results"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Looking at raw numbers is fine but it is better to visualize the actions on a pitch. In order to do that, we provide a proper <code>show_results()</code> method that knows how to display the sequence together with the predictions:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">base_fig_size</span> <span class="o">=</span> <span class="mi">12</span>

<span class="n">test_dl</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span>
    <span class="n">dl</span><span class="o">=</span><span class="n">test_dl</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">base_fig_size</span><span class="p">,</span> <span class="n">base_fig_size</span> <span class="o">*</span> <span class="mf">2.7</span><span class="p">),</span>
    <span class="n">max_n</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Predict-full-possession">Predict full possession<a class="anchor-link" href="#Predict-full-possession"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can predict a full possession in the same way:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">goal_file_path</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">files_info</span><span class="p">[(</span><span class="n">files_info</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;goal&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">files_info</span><span class="o">.</span><span class="n">nSteps</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)]</span>
    <span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">seq_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">goal_file_path</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">predict_poss</span><span class="p">(</span><span class="n">seq_df</span><span class="p">)</span>
<span class="n">x2</span><span class="p">[</span>
    <span class="p">[</span>
        <span class="s2">&quot;type_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;attack_type_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;time_seconds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;player_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_x&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_y&quot;</span><span class="p">,</span>
        <span class="s2">&quot;end_x&quot;</span><span class="p">,</span>
        <span class="s2">&quot;end_y&quot;</span><span class="p">,</span>
        <span class="s2">&quot;is_poss_team&quot;</span><span class="p">,</span>
        <span class="s2">&quot;is_att_team&quot;</span><span class="p">,</span>
        <span class="s2">&quot;proba_goal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;proba_no-goal&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Predict-a-full-game">Predict a full game<a class="anchor-link" href="#Predict-a-full-game"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">footSeq.config.mongo</span> <span class="kn">import</span> <span class="n">mongo_init</span>

<span class="n">mongo_init</span><span class="p">(</span><span class="s2">&quot;prod_atlas&quot;</span><span class="p">)</span>

<span class="n">game_id</span> <span class="o">=</span> <span class="mi">2162755</span>
<span class="n">game_probs</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">predict_game</span><span class="p">(</span><span class="n">game_id</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">game_probs</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

